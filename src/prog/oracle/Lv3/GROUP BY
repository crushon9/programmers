-- 즐겨찾기가 가장 많은 식당 정보 출력하기
-- 오라클에서 GROUP BY는 GROUP BY로 묶은 컬럼과 집계함수로 묶은 컬럼만 가져올수있다.
-- (MY SQL은 위 조건은 제외한 일반 컬럼을 SELECT하면 그냥 첫번째 행의 값을 가져온다)
SELECT R.FOOD_TYPE, R.REST_ID, R.REST_NAME, R.FAVORITES
FROM REST_INFO R
INNER JOIN
(SELECT FOOD_TYPE, MAX(FAVORITES) AS FAVORITES
            FROM REST_INFO
            GROUP BY FOOD_TYPE) a
ON a.FOOD_TYPE = R.FOOD_TYPE
AND a.FAVORITES = R.FAVORITES
ORDER BY R.FOOD_TYPE DESC;


-- 헤비 유저가 소유한 장소
-- GROUP BY로 안 묶인 컬럼(ID, 등등)을 SELECT 하면 'GROUP BY 표현식이 아닙니다' 에러
SELECT * FROM PLACES
WHERE HOST_ID IN (SELECT HOST_ID
FROM PLACES
GROUP BY HOST_ID
HAVING COUNT(*) > 1)
ORDER BY ID;


-- 식품분류별 가장 비싼 식품의 정보 조회하기
SELECT R.CATEGORY, R.PRICE, R.PRODUCT_NAME
FROM FOOD_PRODUCT R
INNER JOIN
(SELECT CATEGORY, MAX(PRICE) AS PRICE
            FROM FOOD_PRODUCT
            GROUP BY CATEGORY) a
ON a.CATEGORY = R.CATEGORY
AND a.PRICE = R.PRICE
WHERE R.CATEGORY IN ('과자', '국', '김치', '식용유')
ORDER BY R.PRICE DESC;


-- 카테고리 별 도서 판매량 집계하기
SELECT B.CATEGORY, SUM(SALES) AS TOTAL_SALES
FROM BOOK_SALES S
LEFT JOIN BOOK B
ON B.BOOK_ID = S.BOOK_ID
WHERE TO_CHAR(S.SALES_DATE, 'YYYYMM') = '202201'
GROUP BY B.CATEGORY
ORDER BY B.CATEGORY;


-- 조건에 맞는 사용자와 총 거래금액 조회하기
SELECT U.USER_ID, U.NICKNAME, S.TOTAL_SALES
FROM USED_GOODS_USER U
INNER JOIN
    (SELECT WRITER_ID, SUM(PRICE) AS TOTAL_SALES
    FROM USED_GOODS_BOARD
    WHERE STATUS = 'DONE'
    GROUP BY WRITER_ID
    HAVING SUM(PRICE) >= 700000) S
ON S.WRITER_ID = U.USER_ID
ORDER BY S.TOTAL_SALES;


-- 자동차 대여 기록에서 대여중 / 대여 가능 여부 구분하기
-- 한글정렬로 MAX
SELECT
    H.CAR_ID
    ,MAX(CASE
     WHEN TO_DATE('20221016','YYYYMMDD') >= H.START_DATE
     AND TO_DATE('20221016','YYYYMMDD') <= H.END_DATE THEN '대여중'
     ELSE '대여 가능' END) AS AVAILABILITY
FROM CAR_RENTAL_COMPANY_RENTAL_HISTORY H
GROUP BY CAR_ID
ORDER BY CAR_ID DESC;

