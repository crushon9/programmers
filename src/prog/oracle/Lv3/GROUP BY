-- 즐겨찾기가 가장 많은 식당 정보 출력하기
-- 오라클에서 GROUP BY는 GROUP BY로 묶은 컬럼과 집계함수로 묶은 컬럼만 가져올수있다.
-- (MY SQL은 위 조건은 제외한 일반 컬럼을 SELECT하면 그냥 첫번째 행의 값을 가져온다)
SELECT R.FOOD_TYPE, R.REST_ID, R.REST_NAME, R.FAVORITES
FROM REST_INFO R
INNER JOIN
(SELECT FOOD_TYPE, MAX(FAVORITES) AS FAVORITES
            FROM REST_INFO
            GROUP BY FOOD_TYPE) a
ON a.FOOD_TYPE = R.FOOD_TYPE
AND a.FAVORITES = R.FAVORITES
ORDER BY R.FOOD_TYPE DESC;


-- 헤비 유저가 소유한 장소
-- GROUP BY로 안 묶인 컬럼(ID, 등등)을 SELECT 하면 'GROUP BY 표현식이 아닙니다' 에러
SELECT * FROM PLACES
WHERE HOST_ID IN (SELECT HOST_ID
FROM PLACES
GROUP BY HOST_ID
HAVING COUNT(*) > 1)
ORDER BY ID;


-- 카테고리 별 도서 판매량 집계하기
SELECT B.CATEGORY, SUM(SALES) AS TOTAL_SALES
FROM BOOK_SALES S
LEFT JOIN BOOK B
ON B.BOOK_ID = S.BOOK_ID
WHERE TO_CHAR(S.SALES_DATE, 'YYYYMM') = '202201'
GROUP BY B.CATEGORY
ORDER BY B.CATEGORY;


-- 조건에 맞는 사용자와 총 거래금액 조회하기
SELECT U.USER_ID, U.NICKNAME, S.TOTAL_SALES
FROM USED_GOODS_USER U
INNER JOIN
    (SELECT WRITER_ID, SUM(PRICE) AS TOTAL_SALES
    FROM USED_GOODS_BOARD
    WHERE STATUS = 'DONE'
    GROUP BY WRITER_ID
    HAVING SUM(PRICE) >= 700000) S
ON S.WRITER_ID = U.USER_ID
ORDER BY S.TOTAL_SALES;


-- 자동차 대여 기록에서 대여중 / 대여 가능 여부 구분하기
-- 한글정렬로 MAX
SELECT
    H.CAR_ID
    ,MAX(CASE
     WHEN TO_DATE('20221016','YYYYMMDD') >= H.START_DATE
     AND TO_DATE('20221016','YYYYMMDD') <= H.END_DATE THEN '대여중'
     ELSE '대여 가능' END) AS AVAILABILITY
FROM CAR_RENTAL_COMPANY_RENTAL_HISTORY H
GROUP BY CAR_ID
ORDER BY CAR_ID DESC;


-- 대여 횟수가 많은 자동차들의 월별 대여 횟수 구하기
CAR_RENTAL_COMPANY_RENTAL_HISTORY 테이블에서
대여 시작일을 기준으로 2022년 8월부터 2022년 10월까지 총 대여 횟수가 5회 이상인 자동차들에 대해서
해당 기간 동안의** 조건 하나 빠짐
월별 자동차 ID 별 총 대여 횟수(컬럼명: RECORDS) 리스트를 출력하는 SQL문을 작성해주세요.
결과는 월을 기준으로 오름차순 정렬하고, 월이 같다면 자동차 ID를 기준으로 내림차순 정렬해주세요.
특정 월의 총 대여 횟수가 0인 경우에는 결과에서 제외해주세요.
SELECT
    EXTRACT(MONTH FROM H.START_DATE) AS MONTH,
    H.CAR_ID,
    COUNT(*) AS RECORDS
FROM CAR_RENTAL_COMPANY_RENTAL_HISTORY H
INNER JOIN (
    SELECT CAR_ID, COUNT(*)
    FROM CAR_RENTAL_COMPANY_RENTAL_HISTORY
    WHERE START_DATE BETWEEN TO_DATE('20220801','YYYYMMDD')
    AND TO_DATE('20221031','YYYYMMDD')
    GROUP BY CAR_ID
    HAVING COUNT(*) >=5
) J
ON J.CAR_ID = H.CAR_ID
WHERE EXTRACT(MONTH FROM H.START_DATE) BETWEEN 8 AND 10
GROUP BY H.CAR_ID, EXTRACT(MONTH FROM H.START_DATE)
HAVING COUNT(*) > 0
ORDER BY EXTRACT(MONTH FROM H.START_DATE), CAR_ID DESC;
